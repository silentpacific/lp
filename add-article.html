<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LivePulse Universal Engine - Add Article</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            color: #333;
            background: #f8fafc;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        h1 {
            text-align: center;
            margin-bottom: 30px;
            color: #1e293b;
            font-weight: 700;
        }

        .engine-badge {
            background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 10px;
        }

        /* Section 1: Editor + Analysis */
        .editor-section {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 25px rgba(0,0,0,0.08);
            border: 1px solid #e2e8f0;
        }

        .editor-left {
            flex: 2;
            padding: 24px;
        }

        .editor-right {
            flex: 1;
            padding: 24px;
            border-left: 1px solid #e2e8f0;
            background: #f8fafc;
        }

        .editor-box {
            width: 100%;
            min-height: 400px;
            padding: 16px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
            line-height: 1.6;
            resize: vertical;
            font-family: inherit;
            transition: border-color 0.2s;
        }

        .editor-box:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .analyze-btn {
            margin-top: 16px;
            padding: 12px 24px;
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.2s;
        }

        .analyze-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.3);
        }

        .analyze-btn:disabled {
            background: #94a3b8;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .analysis-results h3 {
            margin-bottom: 16px;
            color: #1e293b;
            font-weight: 600;
        }

        .cluster-item, .fact-item {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
            transition: all 0.2s;
        }

        .cluster-item:hover, .fact-item:hover {
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            transform: translateY(-1px);
        }

        .cluster-item {
            border-left: 4px solid #3b82f6;
            background: linear-gradient(135deg, #f1f5f9 0%, #ffffff 100%);
        }

        .fact-item {
            border-left: 4px solid #10b981;
            background: linear-gradient(135deg, #f0fdf4 0%, #ffffff 100%);
        }

        .item-header {
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 8px;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .item-meta {
            font-size: 12px;
            color: #64748b;
            line-height: 1.4;
            margin-bottom: 12px;
        }

        .cluster-facts {
            margin-top: 12px;
            padding-left: 16px;
            border-left: 2px solid #e2e8f0;
        }

        .cluster-fact {
            font-size: 13px;
            margin: 6px 0;
            color: #475569;
            line-height: 1.4;
        }

        .fact-value {
            font-weight: 600;
            color: #1e293b;
        }

        .fact-source {
            color: #64748b;
            font-size: 11px;
        }

        /* Section 2: Preview */
        .preview-section {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 4px 25px rgba(0,0,0,0.08);
            border: 1px solid #e2e8f0;
            margin-bottom: 30px;
        }

        .preview-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 1px solid #e2e8f0;
        }

        .preview-content {
            min-height: 200px;
            line-height: 1.8;
            font-size: 16px;
        }

        /* Enhanced highlighting for different fact types */
        .fact-highlight {
            background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%);
            padding: 2px 6px;
            border-radius: 4px;
            position: relative;
            border-bottom: 2px solid #10b981;
            font-weight: 500;
        }

        .cluster-highlight {
            background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
            padding: 2px 6px;
            border-radius: 4px;
            position: relative;
            border-bottom: 2px solid #3b82f6;
            font-weight: 500;
        }

        .relation-highlight {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            padding: 2px 6px;
            border-radius: 4px;
            border-bottom: 2px solid #f59e0b;
            font-weight: 500;
        }

        .superscript {
            font-size: 10px;
            vertical-align: super;
            color: #dc2626;
            font-weight: bold;
            margin-left: 2px;
        }

        /* Footnotes */
        .footnotes {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 2px solid #e2e8f0;
            font-size: 13px;
        }

        .footnote {
            margin-bottom: 8px;
            color: #64748b;
            padding: 6px 0;
            border-bottom: 1px solid #f1f5f9;
        }

        .footnote:last-child {
            border-bottom: none;
        }

        /* CMS Push Section */
        .cms-section {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 4px 25px rgba(0,0,0,0.08);
            border: 1px solid #e2e8f0;
            text-align: center;
        }

        .cms-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 16px;
            margin-top: 16px;
        }

        .cms-select {
            padding: 12px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
            background: white;
            min-width: 140px;
        }

        .push-btn {
            padding: 12px 30px;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.2s;
        }

        .push-btn:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 8px 25px rgba(16, 185, 129, 0.3);
        }

        .push-btn:disabled {
            background: #94a3b8;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* Status indicators */
        .confidence-high { color: #10b981; font-weight: 600; }
        .confidence-medium { color: #f59e0b; font-weight: 600; }
        .confidence-low { color: #ef4444; font-weight: 600; }

        .kind-badge {
            background: #e2e8f0;
            color: #475569;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
        }

        .kind-metric { background: #dbeafe; color: #1d4ed8; }
        .kind-time { background: #f3e8ff; color: #7c3aed; }
        .kind-computed { background: #fef3c7; color: #d97706; }
        .kind-qualifier { background: #fce7f3; color: #be185d; }
        .kind-subject { background: #ecfdf5; color: #047857; }

        .update-btn {
            margin-left: 8px;
            padding: 4px 8px;
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            font-weight: 500;
            transition: all 0.2s;
        }

        .update-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }

        .update-btn:disabled {
            background: #94a3b8;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .update-btn.updating {
            background: #f59e0b;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Update notifications */
        .update-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            z-index: 1000;
            animation: slideIn 0.3s ease-out;
            max-width: 400px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        }

        .update-notification.success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }

        .update-notification.warning {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        }

        .update-notification.error {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* States */
        .empty-state {
            text-align: center;
            color: #64748b;
            font-style: italic;
            padding: 40px 20px;
            background: #f8fafc;
            border-radius: 8px;
            border: 2px dashed #cbd5e1;
        }

        .loading {
            text-align: center;
            color: #3b82f6;
            font-style: italic;
            padding: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .loading::before {
            content: '';
            width: 16px;
            height: 16px;
            border: 2px solid #3b82f6;
            border-top: 2px solid transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .error {
            text-align: center;
            color: #dc2626;
            font-style: italic;
            padding: 20px;
            background: #fef2f2;
            border: 1px solid #fecaca;
            border-radius: 8px;
        }

        /* Mobile responsiveness */
        @media (max-width: 768px) {
            .editor-section {
                flex-direction: column;
            }
            
            .preview-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            
            .cms-controls {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>LivePulse Universal Engine <span class="engine-badge">v3.0</span></h1>

        <!-- Section 1: Editor + Analysis -->
        <div class="editor-section">
            <!-- Left: Text Editor -->
            <div class="editor-left">
                <h3>Article Content</h3>
                <textarea 
                    id="article-editor" 
                    class="editor-box" 
                    placeholder="Paste or type your article content here...

Example content to try:
The growth of eCommerce in recent years has been extraordinary. In 2021, global online retail sales reached $4.98 trillion, and by 2024, this figure surged to $5.8 trillion."
                >The growth of eCommerce in recent years has been extraordinary. In 2021, global online retail sales reached $4.98 trillion, and by 2024, this figure surged to $5.8 trillion.</textarea>
                <button id="analyze-btn" class="analyze-btn">üß† Analyze with Universal Engine</button>
            </div>

            <!-- Right: Analysis Results -->
            <div class="editor-right">
                <div class="analysis-results">
                    <h3>Universal Data Model Results</h3>
                    <div id="analysis-output">
                        <div class="empty-state">
                            Click "Analyze with Universal Engine" to detect facts and clusters using the advanced data model.
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Section 2: Live Preview -->
        <div class="preview-section">
            <div class="preview-header">
                <h3>üìÑ Live Preview</h3>
                <span id="update-frequency">Auto-update frequency: Not set</span>
            </div>
            <div id="preview-content" class="preview-content">
                <div class="empty-state">
                    Your article preview will appear here after universal engine analysis.
                </div>
            </div>
            <div id="footnotes" class="footnotes" style="display: none;">
                <h4>Tracked Facts & Data Sources:</h4>
            </div>
        </div>

        <!-- Section 3: CMS Push -->
        <div class="cms-section">
            <h3>üöÄ Publish to CMS</h3>
            <p>Push this article with automatic fact updates to your content management system.</p>
            <div class="cms-controls">
                <select id="cms-select" class="cms-select">
                    <option value="wordpress">WordPress</option>
                    <option value="ghost">Ghost CMS</option>
                    <option value="shopify">Shopify</option>
                </select>
                <button id="push-btn" class="push-btn" disabled>üì§ Push to CMS</button>
            </div>
        </div>
    </div>

    <script>
        console.log('üöÄ LivePulse Universal Engine v3.0 - Frontend Ready');

        // Application state
        let analysisResults = null;
        let isAnalyzing = false;

        // DOM elements
        const editor = document.getElementById('article-editor');
        const analyzeBtn = document.getElementById('analyze-btn');
        const analysisOutput = document.getElementById('analysis-output');
        const previewContent = document.getElementById('preview-content');
        const footnotes = document.getElementById('footnotes');
        const updateFrequency = document.getElementById('update-frequency');
        const pushBtn = document.getElementById('push-btn');
        const cmsSelect = document.getElementById('cms-select');

        // Call the enhanced backend API with robust error handling
        async function callUniversalEngine(content) {
            console.log('üß† Calling LivePulse Universal Engine...');
            
            try {
                const response = await fetch('/.netlify/functions/analyze-pulse', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        selectedText: content,
                        articleContent: content,
                        articleTitle: 'Universal Engine Test Article',
                        mode: 'full_article_scan'
                    })
                });

                if (!response.ok) {
                    // Try to get error details from response
                    let errorDetails = `HTTP ${response.status}`;
                    try {
                        const errorData = await response.json();
                        errorDetails = errorData.error || errorDetails;
                    } catch (parseError) {
                        // If we can't parse the error response, use status
                        errorDetails = `HTTP ${response.status} - ${response.statusText}`;
                    }
                    throw new Error(errorDetails);
                }

                const result = await response.json();
                
                if (!result.success) {
                    throw new Error(result.error || 'Universal engine analysis failed');
                }

                console.log('‚úÖ Universal Engine Success:', result);
                
                // Handle fallback mode
                if (result.fallback) {
                    console.log('‚ö†Ô∏è Using fallback analysis mode');
                }
                
                return result.analysis;

            } catch (error) {
                console.error('‚ùå Universal Engine failed:', error);
                
                // Check if it's a network error
                if (error.message.includes('fetch')) {
                    throw new Error('Network connection failed. Please check your internet connection.');
                }
                
                // Check if it's a server error
                if (error.message.includes('500')) {
                    throw new Error('Server error. The Universal Engine may be experiencing issues. Please try again.');
                }
                
                throw error;
            }
        }

        // Analyze button handler
        analyzeBtn.addEventListener('click', async () => {
            const content = editor.value.trim();
            if (!content) {
                alert('Please enter some content to analyze.');
                return;
            }

            if (isAnalyzing) return;

            isAnalyzing = true;
            analyzeBtn.disabled = true;
            analyzeBtn.textContent = '‚è≥ Analyzing...';
            
            analysisOutput.innerHTML = '<div class="loading">Processing with Universal Data Model...</div>';

            try {
                console.log('üéØ Starting Universal Engine analysis...');
                analysisResults = await callUniversalEngine(content);
                console.log('üìä Analysis Results:', analysisResults);
                
                displayUniversalResults();
                generateEnhancedPreview();
                enableCMSPush();
                
                console.log('‚úÖ Universal Engine analysis complete!');
            } catch (error) {
                console.error('üí• Analysis failed:', error);
                
                let errorMessage = error.message;
                let errorClass = 'error';
                
                // Handle different error types with better messaging
                if (error.message.includes('Network connection failed')) {
                    errorMessage = 'üåê Network Error: Please check your internet connection and try again.';
                } else if (error.message.includes('Server error')) {
                    errorMessage = '‚öôÔ∏è Server Error: The Universal Engine is temporarily unavailable. Please try again in a few moments.';
                    errorClass = 'error';
                } else if (error.message.includes('HTTP 500')) {
                    errorMessage = 'üîß Universal Engine Error: There was an issue processing your content. Please try with different text or contact support.';
                } else if (error.message.includes('timeout')) {
                    errorMessage = '‚è±Ô∏è Timeout Error: The analysis took too long. Please try with shorter content.';
                } else {
                    errorMessage = `üö® Analysis Error: ${error.message}`;
                }
                
                analysisOutput.innerHTML = `
                    <div class="${errorClass}">
                        ${errorMessage}
                        <br><br>
                        <strong>Troubleshooting Tips:</strong><br>
                        ‚Ä¢ Try with shorter content (under 1000 words)<br>
                        ‚Ä¢ Ensure your content contains numbers, dates, or statistics<br>
                        ‚Ä¢ Check your internet connection<br>
                        ‚Ä¢ Refresh the page and try again
                    </div>
                `;
            } finally {
                isAnalyzing = false;
                analyzeBtn.disabled = false;
                analyzeBtn.textContent = 'üß† Analyze with Universal Engine';
            }
        });

        // Display results using the Universal Data Model structure
        function displayUniversalResults() {
            const { facts, clusters } = analysisResults;
            let html = '';
            let itemNumber = 1;

            if ((!facts || facts.length === 0) && (!clusters || clusters.length === 0)) {
                html = '<div class="empty-state">No facts or clusters detected by the Universal Engine. Try adding some prices, dates, or statistics.</div>';
            } else {
                // Always show Clusters section first
                html += '<h4 style="color: #1e293b; margin-bottom: 12px; font-weight: 600;">üîó Clusters</h4>';
                
                if (clusters && clusters.length > 0) {
                    clusters.forEach(cluster => {
                        html += `
                            <div class="cluster-item">
                                <div class="item-header">
                                    ${itemNumber}. ${cluster.title}
                                </div>
                                <div class="item-meta">
                                    <strong>Relation:</strong> ${cluster.relation}<br>
                                    <strong>Summary:</strong> ${cluster.summary}<br>
                                    <strong>Frequency:</strong> ${getClusterFrequency(cluster)}
                                </div>
                                <div class="cluster-facts">
                                    ${cluster.facts.map((fact, index) => `
                                        <div class="cluster-fact">
                                            ${itemNumber}.${index + 1} <span class="kind-badge kind-${fact.kind}">${fact.kind}</span> 
                                            <span class="fact-value">${getFactDisplayValue(fact)}</span>
                                            ${fact.kind === 'metric' || fact.kind === 'computed' ? 
                                                `<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="fact-source">${fact.source} ‚Ä¢ ${fact.updates_every} ‚Ä¢ <span class="confidence-${fact.confidence.toLowerCase()}">${fact.confidence}</span></span>
                                                 <button class="update-btn" onclick="updateFactRealTime('${fact.id}', '${fact.kind}', '${fact.subject}')">üîÑ Update Now</button>` : 
                                                ''
                                            }
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        `;
                        itemNumber++;
                    });
                } else {
                    html += '<div class="empty-state" style="margin-bottom: 20px;">No clusters detected in this content.</div>';
                }

                // Check for standalone facts (though as you noted, there should always be clusters)
                const standaloneFacts = facts.filter(fact => 
                    !clusters.some(cluster => cluster.members.includes(fact.id))
                );
                
                if (standaloneFacts.length > 0) {
                    html += '<h4 style="color: #1e293b; margin: 20px 0 12px 0; font-weight: 600;">üìä Facts</h4>';
                    
                    standaloneFacts.forEach(fact => {
                        html += `
                            <div class="fact-item">
                                <div class="item-header">
                                    ${itemNumber}. ${fact.title} <span class="kind-badge kind-${fact.kind}">${fact.kind}</span>
                                </div>
                                <div class="item-meta">
                                    <strong>Value:</strong> ${getFactDisplayValue(fact)}<br>
                                    <strong>Subject:</strong> ${fact.subject} ‚Ä¢ <strong>Geography:</strong> ${fact.geo}<br>
                                    <strong>Frequency:</strong> ${getFactFrequency(fact)}<br>
                                    <strong>Source:</strong> ${fact.source} ‚Ä¢ <strong>Confidence:</strong> <span class="confidence-${fact.confidence.toLowerCase()}">${fact.confidence}</span>
                                    <button class="update-btn" onclick="updateFactRealTime('${fact.id}', '${fact.kind}', '${fact.subject}')">üîÑ Update Now</button>
                                </div>
                            </div>
                        `;
                        itemNumber++;
                    });
                }
            }

            analysisOutput.innerHTML = html;
        }

        // Get cluster frequency information
        function getClusterFrequency(cluster) {
            if (!cluster.facts || cluster.facts.length === 0) {
                return 'Not applicable';
            }
            
            // Check if any facts contain historical data (years like 2021, 2024)
            const hasHistoricalData = cluster.facts.some(fact => 
                fact.kind === 'time' && fact.value.year && fact.value.year < new Date().getFullYear()
            );
            
            if (hasHistoricalData) {
                return 'Not applicable (historical data)';
            }
            
            // Get the most frequent update from cluster facts
            const frequencies = cluster.facts
                .map(f => f.updates_every)
                .filter(f => f);
                
            if (frequencies.length === 0) {
                return 'Not applicable';
            }
            
            // Return the most frequent (shortest interval)
            const mostFrequent = frequencies.reduce((min, freq) => {
                if (freq.includes('hour')) return freq;
                if (freq.includes('day') && !min.includes('hour')) return freq;
                return min;
            }, frequencies[0]);
            
            return `Every ${mostFrequent}`;
        }

        // Get individual fact frequency
        function getFactFrequency(fact) {
            // Check if it's historical data
            if (fact.kind === 'time' && fact.value.year && fact.value.year < new Date().getFullYear()) {
                return 'Not applicable (historical data)';
            }
            
            return fact.updates_every ? `Every ${fact.updates_every}` : 'Not applicable';
        }

        // Get display value based on Universal Data Model structure
        function getFactDisplayValue(fact) {
            switch (fact.kind) {
                case 'metric':
                    if (fact.value.currency) {
                        const unit = fact.value.unit ? ` ${fact.value.unit}` : '';
                        return `<strong>${formatNumber(fact.value.num)}${unit}</strong> <em>(${fact.value.currency})</em>`;
                    } else if (fact.value.unit) {
                        return `<strong>${formatNumber(fact.value.num)} ${fact.value.unit}</strong>`;
                    }
                    return `<strong>${formatNumber(fact.value.num)}</strong>`;
                
                case 'time':
                    if (fact.value.year) return `<strong>${fact.value.year}</strong>`;
                    if (fact.value.range) return `<strong>${fact.value.range}</strong>`;
                    return `<strong>${fact.value.text}</strong>`;
                
                case 'computed':
                    let result = '';
                    if (fact.value.abs) result += `<strong>${fact.value.abs}</strong>`;
                    if (fact.value.pct) result += ` <em>(${fact.value.pct}%)</em>`;
                    if (fact.value.direction) {
                        const arrow = fact.value.direction === 'up' ? '‚ÜóÔ∏è' : fact.value.direction === 'down' ? '‚ÜòÔ∏è' : '‚Üí';
                        result += ` ${arrow}`;
                    }
                    return result || fact.original_text;
                
                case 'qualifier':
                    const intensity = fact.value.intensity ? ` (${fact.value.intensity} intensity)` : '';
                    return `<em>${fact.value.text}${intensity}</em>`;
                
                case 'subject':
                default:
                    return `<em>${fact.value.text || fact.original_text}</em>`;
            }
        }

        // Format numbers with commas
        function formatNumber(num) {
            if (typeof num === 'number') {
                return num.toLocaleString();
            }
            return num;
        }

        // Generate enhanced preview with Universal Data Model
        function generateEnhancedPreview() {
            const { facts, clusters } = analysisResults;
            let content = editor.value;
            let footnoteNumber = 1;
            let footnotesList = [];
            let processedTexts = new Set(); // Track processed text to avoid duplicates

            // Get all facts
            const allFacts = [...facts];
            clusters.forEach(cluster => allFacts.push(...cluster.facts));

            // Set update frequency based on most frequent updates needed
            if (allFacts.length > 0) {
                const frequencies = allFacts.map(f => f.updates_every).filter(f => f);
                const mostFrequent = frequencies.reduce((min, freq) => {
                    if (freq.includes('hour')) return freq;
                    if (freq.includes('day') && !min.includes('hour')) return freq;
                    return min;
                }, frequencies[0] || 'daily');
                
                updateFrequency.textContent = `Auto-update frequency: Every ${mostFrequent}`;
            }

            // Process clusters first (primary facts get highlighted)
            clusters.forEach(cluster => {
                cluster.facts.forEach(fact => {
                    // Only highlight metric and computed facts, skip if already processed
                    if ((fact.kind === 'metric' || fact.kind === 'computed') && !processedTexts.has(fact.original_text)) {
                        const regex = new RegExp(escapeRegExp(fact.original_text), 'g');
                        content = content.replace(regex, 
                            `<span class="cluster-highlight">${fact.original_text}<span class="superscript">${footnoteNumber}</span></span>`
                        );
                        footnotesList.push(`${footnoteNumber}. ${fact.title} - ${getFactDisplayValue(fact).replace(/<[^>]*>/g, '')} ‚Ä¢ ${fact.source} ‚Ä¢ ${fact.updates_every} ‚Ä¢ ${fact.confidence}`);
                        footnoteNumber++;
                        processedTexts.add(fact.original_text);
                    }
                });
            });

            // Process standalone facts
            const standaloneFacts = facts.filter(fact => 
                !clusters.some(cluster => cluster.members.includes(fact.id))
            );
            
            standaloneFacts.forEach(fact => {
                // Only highlight if not already processed
                if (!processedTexts.has(fact.original_text)) {
                    const regex = new RegExp(escapeRegExp(fact.original_text), 'g');
                    content = content.replace(regex, 
                        `<span class="fact-highlight">${fact.original_text}<span class="superscript">${footnoteNumber}</span></span>`
                    );
                    footnotesList.push(`${footnoteNumber}. ${fact.title} - ${getFactDisplayValue(fact).replace(/<[^>]*>/g, '')} ‚Ä¢ ${fact.source} ‚Ä¢ ${fact.updates_every} ‚Ä¢ ${fact.confidence}`);
                    footnoteNumber++;
                    processedTexts.add(fact.original_text);
                }
            });

            // Only highlight specific qualifiers, not general words
            const specificQualifiers = ['extraordinary', 'unprecedented', 'remarkable', 'exceptional', 'outstanding', 'dramatic', 'substantial', 'significant'];
            const qualifierPattern = new RegExp(`\\b(${specificQualifiers.join('|')})\\b`, 'gi');
            content = content.replace(qualifierPattern, 
                (match) => `<span class="relation-highlight">${match}</span>`
            );

            // Display preview with better paragraph formatting
            previewContent.innerHTML = content.split('\n')
                .map(p => p.trim() ? `<p>${p}</p>` : '')
                .join('');

            // Display enhanced footnotes
            if (footnotesList.length > 0) {
                footnotes.style.display = 'block';
                footnotes.innerHTML = `
                    <h4>Universal Data Model - Tracked Facts & Sources:</h4>
                    ${footnotesList.map(footnote => `<div class="footnote">${footnote}</div>`).join('')}
                `;
            }
        }

        // Enable CMS push
        function enableCMSPush() {
            pushBtn.disabled = false;
        }

        // CMS push handler
        pushBtn.addEventListener('click', () => {
            const cms = cmsSelect.value;
            const { facts, clusters } = analysisResults;
            const totalItems = (facts?.length || 0) + (clusters?.length || 0);
            
            alert(`Would push article to ${cms.toUpperCase()} with Universal Data Model:\n\n‚Ä¢ ${facts?.length || 0} individual facts\n‚Ä¢ ${clusters?.length || 0} semantic clusters\n‚Ä¢ Total tracked items: ${totalItems}\n\nThis would set up automatic updates using the Universal Engine.`);
        });

        // Utility functions
        function escapeRegExp(string) {
            return string.replace(/[.*+?^${}()|[\]\\]/g, '\\                <button id="push-btn" class="');
        }

        console.log('üöÄ Universal Engine Frontend Ready - Lightweight & Fast!');
    </script>
</body>
</html>