<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LivePulse MVP - Add Article</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            color: #333;
            background: #f5f5f5;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        h1 {
            text-align: center;
            margin-bottom: 30px;
            color: #2c3e50;
        }

        /* Section 1: Editor + Analysis */
        .editor-section {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .editor-left {
            flex: 2;
            padding: 20px;
        }

        .editor-right {
            flex: 1;
            padding: 20px;
            border-left: 1px solid #eee;
            background: #fafafa;
        }

        .editor-box {
            width: 100%;
            min-height: 400px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            line-height: 1.6;
            resize: vertical;
        }

        .analyze-btn {
            margin-top: 15px;
            padding: 12px 24px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }

        .analyze-btn:hover {
            background: #2980b9;
        }

        .analyze-btn:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
        }

        .analysis-results h3 {
            margin-bottom: 15px;
            color: #2c3e50;
        }

        .fact-item, .cluster-item {
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 12px;
            margin-bottom: 10px;
        }

        .cluster-item {
            border-left: 4px solid #3498db;
        }

        .fact-item {
            border-left: 4px solid #27ae60;
        }

        .fact-text {
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 8px;
        }

        .fact-meta {
            font-size: 12px;
            color: #7f8c8d;
        }

        .cluster-facts {
            margin-top: 10px;
            padding-left: 15px;
        }

        .cluster-fact {
            font-size: 13px;
            margin: 4px 0;
            color: #34495e;
        }

        /* Section 2: Preview */
        .preview-section {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .preview-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }

        .preview-content {
            min-height: 200px;
            line-height: 1.8;
            font-size: 16px;
        }

        /* Highlighting styles */
        .fact-highlight {
            background-color: #d5f4e6;
            padding: 2px 4px;
            border-radius: 3px;
            position: relative;
        }

        .cluster-highlight {
            background-color: #dae8fc;
            padding: 2px 4px;
            border-radius: 3px;
            position: relative;
        }

        .relation-highlight {
            background-color: #fff2cc;
            padding: 2px 4px;
            border-radius: 3px;
        }

        .superscript {
            font-size: 10px;
            vertical-align: super;
            color: #e74c3c;
            font-weight: bold;
        }

        /* Footnotes */
        .footnotes {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #eee;
            font-size: 14px;
        }

        .footnote {
            margin-bottom: 8px;
            color: #7f8c8d;
        }

        /* CMS Push Section */
        .cms-section {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
        }

        .cms-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            margin-top: 15px;
        }

        .cms-select {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .push-btn {
            padding: 12px 30px;
            background: #27ae60;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
        }

        .push-btn:hover {
            background: #229954;
        }

        .empty-state {
            text-align: center;
            color: #7f8c8d;
            font-style: italic;
            padding: 30px;
        }

        .loading {
            text-align: center;
            color: #3498db;
            font-style: italic;
            padding: 20px;
        }

        .error {
            text-align: center;
            color: #e74c3c;
            font-style: italic;
            padding: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>LivePulse - Add Article</h1>

        <!-- Section 1: Editor + Analysis -->
        <div class="editor-section">
            <!-- Left: Text Editor -->
            <div class="editor-left">
                <h3>Article Content</h3>
                <textarea 
                    id="article-editor" 
                    class="editor-box" 
                    placeholder="Paste or type your article content here...

Example content to try:
The growth of eCommerce in recent years has been extraordinary. In 2021, global online retail sales reached $4.98 trillion, and by 2024, this figure surged to $5.8 trillion."
                >The growth of eCommerce in recent years has been extraordinary. In 2021, global online retail sales reached $4.98 trillion, and by 2024, this figure surged to $5.8 trillion.</textarea>
                <button id="analyze-btn" class="analyze-btn">üîç Analyze Content</button>
            </div>

            <!-- Right: Analysis Results -->
            <div class="editor-right">
                <div class="analysis-results">
                    <h3>Facts & Clusters</h3>
                    <div id="analysis-output">
                        <div class="empty-state">
                            Click "Analyze Content" to detect facts and clusters in your article.
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Section 2: Live Preview -->
        <div class="preview-section">
            <div class="preview-header">
                <h3>üìÑ Live Preview</h3>
                <span id="update-frequency">Auto-update frequency: Not set</span>
            </div>
            <div id="preview-content" class="preview-content">
                <div class="empty-state">
                    Your article preview will appear here after analysis.
                </div>
            </div>
            <div id="footnotes" class="footnotes" style="display: none;">
                <h4>Sources & Update Frequencies:</h4>
            </div>
        </div>

        <!-- Section 3: CMS Push -->
        <div class="cms-section">
            <h3>üöÄ Publish to CMS</h3>
            <p>Push this article with automatic fact updates to your content management system.</p>
            <div class="cms-controls">
                <select id="cms-select" class="cms-select">
                    <option value="wordpress">WordPress</option>
                    <option value="ghost">Ghost CMS</option>
                    <option value="shopify">Shopify</option>
                </select>
                <button id="push-btn" class="push-btn" disabled>üì§ Push to CMS</button>
            </div>
        </div>
    </div>

    <script>
        console.log('üöÄ ADD-ARTICLE.HTML SCRIPT LOADED!');
        console.log('üîç LivePulse object:', window.LivePulse);
        console.log('üîß Loading LivePulse...');

        // Application state
        let analysisResults = null;
        let isAnalyzing = false;

        // DOM elements
        const editor = document.getElementById('article-editor');
        const analyzeBtn = document.getElementById('analyze-btn');
        const analysisOutput = document.getElementById('analysis-output');
        const previewContent = document.getElementById('preview-content');
        const footnotes = document.getElementById('footnotes');
        const updateFrequency = document.getElementById('update-frequency');
        const pushBtn = document.getElementById('push-btn');
        const cmsSelect = document.getElementById('cms-select');

        // Real API call to analyze-pulse function
        async function callRealAPI(content) {
            console.log('üîç Calling REAL LivePulse analyze-pulse function...');
            
            try {
                const response = await fetch('/.netlify/functions/analyze-pulse', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        selectedText: content,
                        articleContent: content,
                        articleTitle: 'MVP Test Article',
                        mode: 'full_article_scan'
                    })
                });

                if (!response.ok) {
                    throw new Error(`API Error: ${response.status}`);
                }

                const result = await response.json();
                
                if (!result.success) {
                    throw new Error(result.error || 'Analysis failed');
                }

                console.log('‚úÖ Real API Success:', result);

                // Convert API response to display format
                const pulsePoints = (result.analysis?.pulsePoints || []).map(pulse => ({
                    id: pulse.id || `pulse-${Math.random()}`,
                    text: pulse.selectedText || pulse.text,
                    type: pulse.pulseType || pulse.type || 'other',
                    source: pulse.dataSource || 'Unknown',
                    frequency: getFrequencyText(pulse.updateFrequency),
                    entity: pulse.entity || pulse.specificType || 'Unknown',
                    confidence: pulse.confidence || 'medium',
                    reasoning: pulse.reasoning || 'Detected by AI'
                }));

                return { facts: pulsePoints, clusters: [] };

            } catch (error) {
                console.error('‚ùå Real API failed:', error);
                throw error;
            }
        }

        // Convert frequency minutes to text
        function getFrequencyText(minutes) {
            if (!minutes) return '1 day';
            if (minutes < 60) return `${minutes} minutes`;
            if (minutes < 1440) return `${Math.round(minutes / 60)} hours`;
            if (minutes < 43200) return `${Math.round(minutes / 1440)} days`;
            return `${Math.round(minutes / 43200)} months`;
        }

        // Analyze button handler
        analyzeBtn.addEventListener('click', async () => {
            const content = editor.value.trim();
            if (!content) {
                alert('Please enter some content to analyze.');
                return;
            }

            if (isAnalyzing) return;

            isAnalyzing = true;
            analyzeBtn.disabled = true;
            analyzeBtn.textContent = '‚è≥ Analyzing...';
            
            analysisOutput.innerHTML = '<div class="loading">Calling LivePulse AI engine...</div>';

            try {
                console.log('üéØ Starting real API analysis...');
                analysisResults = await callRealAPI(content);
                console.log('üìä Analysis Results:', analysisResults);
                
                displayAnalysisResults();
                generatePreview();
                enableCMSPush();
                
                console.log('‚úÖ Analysis complete!');
            } catch (error) {
                console.error('üí• Analysis failed:', error);
                analysisOutput.innerHTML = `<div class="error">Analysis failed: ${error.message}</div>`;
            } finally {
                isAnalyzing = false;
                analyzeBtn.disabled = false;
                analyzeBtn.textContent = 'üîç Analyze Content';
            }
        });

        // Display analysis results
        function displayAnalysisResults() {
            const { facts, clusters } = analysisResults;
            let html = '';

            if ((!facts || facts.length === 0) && (!clusters || clusters.length === 0)) {
                html = '<div class="empty-state">No facts or clusters detected. Try adding some prices, dates, or statistics.</div>';
            } else {
                // Display clusters first
                if (clusters && clusters.length > 0) {
                    clusters.forEach(cluster => {
                        html += `
                            <div class="cluster-item">
                                <div class="fact-text">üîó ${cluster.name}</div>
                                <div class="fact-meta">Source: ${cluster.source} | Updates: Every ${cluster.frequency}</div>
                                <div class="cluster-facts">
                                    ${cluster.facts.map(fact => `
                                        <div class="cluster-fact">‚Ä¢ ${fact.text} (${fact.type})</div>
                                    `).join('')}
                                </div>
                            </div>
                        `;
                    });
                }

                // Display individual facts
                if (facts && facts.length > 0) {
                    facts.forEach(fact => {
                        html += `
                            <div class="fact-item">
                                <div class="fact-text">üìä ${fact.text}</div>
                                <div class="fact-meta">
                                    Type: ${fact.type}<br>
                                    Entity: ${fact.entity}<br>
                                    Source: ${fact.source}<br>
                                    Updates: Every ${fact.frequency}<br>
                                    Confidence: ${fact.confidence}<br>
                                    Reason: ${fact.reasoning}
                                </div>
                            </div>
                        `;
                    });
                }
            }

            analysisOutput.innerHTML = html;
        }

        // Generate preview with highlighting
        function generatePreview() {
            const { facts, clusters } = analysisResults;
            let content = editor.value;
            let footnoteNumber = 1;
            let footnotesList = [];

            // Get all facts from both individual facts and clusters
            let allFacts = [...(facts || [])];
            if (clusters) {
                clusters.forEach(cluster => {
                    allFacts.push(...cluster.facts);
                });
            }

            // Set update frequency based on facts found
            if (allFacts.length > 0) {
                updateFrequency.textContent = `Auto-update frequency: Every ${allFacts[0].frequency}`;
            }

            // Process individual facts
            allFacts.forEach(fact => {
                const regex = new RegExp(escapeRegExp(fact.text), 'g');
                content = content.replace(regex, 
                    `<span class="fact-highlight">${fact.text}<span class="superscript">${footnoteNumber}</span></span>`
                );
                footnotesList.push(`${footnoteNumber}. ${fact.text} - Source: ${fact.source}, Updates: Every ${fact.frequency}`);
                footnoteNumber++;
            });

            // Add relation highlighting (simple patterns)
            content = content.replace(/(up|down|increased|decreased|higher|lower|surged|reached)\s/gi, 
                (match) => `<span class="relation-highlight">${match}</span>`
            );

            // Display preview
            previewContent.innerHTML = content.split('\n').map(p => p.trim() ? `<p>${p}</p>` : '').join('');

            // Display footnotes
            if (footnotesList.length > 0) {
                footnotes.style.display = 'block';
                footnotes.innerHTML = `
                    <h4>Sources & Update Frequencies:</h4>
                    ${footnotesList.map(footnote => `<div class="footnote">${footnote}</div>`).join('')}
                `;
            }
        }

        // Enable CMS push
        function enableCMSPush() {
            pushBtn.disabled = false;
        }

        // CMS push handler
        pushBtn.addEventListener('click', () => {
            const cms = cmsSelect.value;
            const { facts, clusters } = analysisResults;
            const totalItems = (facts?.length || 0) + (clusters?.length || 0);
            
            alert(`Would push article to ${cms.toUpperCase()} with ${totalItems} tracked facts/clusters.\n\nThis would set up automatic updates for all detected facts.`);
        });

        // Utility functions
        function escapeRegExp(string) {
            return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        }

        console.log('üöÄ LivePulse ready - will call REAL API!');
    </script>
</body>
</html>